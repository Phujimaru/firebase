<!DOCTYPE html>
<html>
    <head>
        <title>Classroom Check-in</title>
        <script
            src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
        <script
            src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
        <script
            src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.css"
            rel="stylesheet" />
        <script
            src="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.js"></script>
        <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        .full-height {
            height: 100vh;
        }
        .login-bg {
            background: url('https://source.unsplash.com/1600x900/?classroom') center/cover no-repeat;
        }
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
    </head>
    <body>
        <div id="app">
            <v-app>
                <template v-if="!user">
                    <!-- ‡∏´‡∏ô‡πâ‡∏≤ Login -->
                    <v-container
                        class="full-height login-bg d-flex justify-center align-center">
                        <v-card class="pa-5 text-center" elevation="10"
                            style="opacity: 0.9;">
                            <h1 class="text-shadow">Welcome to Classroom
                                Check-in</h1>
                            <p class="mb-4">Please login to continue</p>
                            <v-btn @click="google_login" color="green" block>
                                Login with Google
                            </v-btn>
                        </v-card>
                    </v-container>
                </template>

                <template v-if="user && userStatus === null">
                    <v-container
                        class="full-height d-flex justify-center align-center">
                        <v-card class="pa-5 text-center" elevation="10"
                            style="opacity: 0.9;">
                            <h2 class="text-shadow">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                            <p
                                class="mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
                            <v-btn color="blue" block class="mb-2"
                                @click="setUserStatus(1)">‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</v-btn>
                            <v-btn color="green" block
                                @click="setUserStatus(2)">‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</v-btn>
                        </v-card>
                    </v-container>
                </template>

                <template v-else>
                    <v-container fluid class="full-height">
                        <v-row class="fill-height">
                            <!-- Sidebar ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ -->
                            <v-col cols="12" md="3" class="pa-4"
                                style="background-color: #f4f4f9;">
                                <v-card class="pa-3" elevation="3" style="text-align: center;">
                                    <v-avatar v-if="user" size="100" class="d-inline-block">
                                        <img :src="user.photoURL" class="rounded-0" style="width: 100px; height: 100px; object-fit: cover;" />
                                    </v-avatar>
                                    
                                    <div v-if="user" class="user-details mt-3">
                                        <strong>{{ user.displayName }}</strong>
                                        <p>{{ user.email }}</p>
                                        <p>Status:
                                            <span :class="userStatus === 1 ? 'text-blue' : 'text-green'">
                                                {{ userStatus === 1 ? 'Teacher' : 'Student' }}
                                            </span>
                                        </p>
                                    </div>
                                    
                                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π -->
                                    <v-divider class="mt-3 mb-3"></v-divider>
                                    <v-btn v-if="userStatus === 1"
                                        color="primary" block class="mb-2"
                                        @click="goToCreateClassroom">
                                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                    </v-btn>
                                    <v-btn @click="google_logout" color="red" block class="mb-2">
                                        Logout
                                    </v-btn>
                                </v-card>
                                
                            </v-col>

                            <v-row v-if="classrooms.length === 0"
                                class="fill-height" align="center"
                                justify="center">
                                <v-col cols="12" class="text-center">
                                    <p
                                        class="text-h6 text-grey">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
                                </v-col>
                            </v-row>

                            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
                            <v-col cols="12" md="9" class="pa-4">
                                <v-container fluid>
                                    <v-row>
                                        <v-col cols="12" md="6"
                                            v-for="classroom in classrooms"
                                            :key="classroom.id">
                                            <v-card elevation="2">
                                                <v-img :src="classroom.image"
                                                    height="200px"></v-img>
                                                <v-card-title>{{ classroom.name
                                                    }}</v-card-title>
                                                <v-card-subtitle>{{
                                                    classroom.teacher
                                                    }}</v-card-subtitle>
                                                <v-card-subtitle>{{
                                                    classroom.subjectCode
                                                    }}</v-card-subtitle>
                                                <v-card-actions>
                                                    <v-btn color="blue"
                                                        @click="goToEditPage(classroom.id)">Manage</v-btn>
                                                    <v-btn color="red"
                                                        @click="confirmDeleteClassroom(classroom.id)">Delete</v-btn>
                                                </v-card-actions>
                                            </v-card>
                                        </v-col>
                                    </v-row>
                                </v-container>
                            </v-col>

                        </v-row>
                    </v-container>
                </template>
            </v-app>
        </div>

        <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCsB5O8vwk_EhCmME6Zg6CqN1gVFl4eJik",
            authDomain: "projectwebm2025.firebaseapp.com",
            projectId: "projectwebm2025",
            storageBucket: "projectwebm2025.firebasestorage.app",
            messagingSenderId: "316415805582",
            appId: "1:316415805582:web:582b27fa7d4f8974bee1df",
            measurementId: "G-EC8J8RGC0T"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const { createApp, ref } = Vue;
        const vuetify = Vuetify.createVuetify();

        createApp({
            data() {
                return {
                    user: null,
                    userStatus: null,
                    classrooms: []
                };
            },
            methods: {
                google_login() {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    firebase.auth().signInWithPopup(provider).then(result => {
                        console.log("‚úÖ Login success:", result.user);
                        this.user = result.user;

                        if (this.user) {
                            const userRef = db.collection("users").doc(this.user.uid);
                            userRef.get().then(doc => {
                                if (!doc.exists) {
                                    console.log("üü° User does not exist in Firestore, asking for status...");
                                } else {
                                    console.log("‚úÖ User found in Firestore:", doc.data());
                                    this.userStatus = doc.data().status;
                                    this.loadClassrooms();
                                }
                            }).catch(error => console.error("‚ùå Firestore error:", error));
                        }
                    }).catch(error => console.error("‚ùå Login error:", error));
                },
                google_logout() {
                    firebase.auth().signOut().then(() => {
                        this.user = null;
                        this.userStatus = null;
                        this.classrooms = [];
                    });
                },
                setUserStatus(status) {
                    this.userStatus = status;
                    db.collection('users').doc(this.user.uid).set({
                        status: status,
                        name: this.user.displayName,
                        email: this.user.email,
                        photo: this.user.photoURL
                }).then(() => {
                        console.log("‚úÖ User data saved:", status);
                    this.loadClassrooms();
                    }).catch(error => console.error("‚ùå Error saving user data:", error));
                },
                checkUserStatus() {
                    if (this.user) {
                        db.collection('users').doc(this.user.uid).get()
                            .then(doc => {
                                if (doc.exists) {
                                    this.userStatus = doc.data().status;
                                    this.loadClassrooms();
                                } else {
                                    this.userStatus = null;
                                }
                            });
                    }
                },
                goToCreateClassroom() {
                    window.location.href = 'create.html';
                },
                goToEditPage(classroomId) {
                    window.location.href = `manage.html?classroomId=${classroomId}`;
                },
                async loadClassrooms() {
                    if (!this.user) return;

                    if (this.userStatus === 1) {
                        // üìå ‡∏Ñ‡∏£‡∏π: ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
                        db.collection('classrooms')
                            .where('userId', '==', this.user.uid)
                            .get()
                            .then(snapshot => {
                                this.classrooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            });
                    } else if (this.userStatus === 2) {
                        // üìå ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡∏î‡∏∂‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å users/{uid}/classroom
                        db.collection('users')
                            .doc(this.user.uid)
                            .collection('classroom')
                            .get()
                            .then(snapshot => {
                                const joinedClassrooms = snapshot.docs.map(doc => doc.id);

                                if (joinedClassrooms.length === 0) {
                                    this.classrooms = []; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                                } else {
                                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                                    db.collection('classrooms')
                                        .where(firebase.firestore.FieldPath.documentId(), 'in', joinedClassrooms)
                                        .get()
                                        .then(classroomSnapshot => {
                                            this.classrooms = classroomSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                        });
                                }
                            });
                    }
                },
                confirmDeleteClassroom(classroomId) {
        if (confirm("Are you sure you want to delete this classroom?")) {
            this.deleteClassroom(classroomId);
        }
    },
    deleteClassroom(classroomId) {
        // ‡∏•‡∏ö Classroom ‡∏à‡∏≤‡∏Å Firestore
        db.collection('classrooms').doc(classroomId).delete()
            .then(() => {
                console.log("‚úÖ Classroom deleted:", classroomId);
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                this.loadClassrooms();
            })
            .catch(error => console.error("‚ùå Error deleting classroom:", error));
             }




            },
            mounted() {
                firebase.auth().onAuthStateChanged(user => {
                    this.user = user;
                    if (user) {
                        this.checkUserStatus();
                    }
                });
            },
            watch: {
                userStatus(newStatus) {
                    if (this.user && newStatus !== null) {
                        this.loadClassrooms();
                    }
                }
            }
        }).use(vuetify).mount("#app");
    </script>

    </body>
</html>
