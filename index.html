<!DOCTYPE html>
<html lang="en">


<head>
    <title>Work6 - Courses & Profile</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.js"></script>
</head>


<body>
    <div id="app">
        <v-app>
            <v-container>
                <v-card>
                    <v-card-title class="bg-blue-grey">{{ title }}</v-card-title>
                    <v-card-text>
                        <v-card-actions>
                            <template v-if="user">
                                <v-avatar size="100">
                                    <img :src="user.photoURL" />
                                </v-avatar>
                                <div>
                                    {{ user.displayName }}<br />
                                    {{ user.email }}<br />
                                    Status: {{ userStatus === 1 ? 'Teacher' : 'Student' }}
                                </div>
                                <v-btn @click="google_logout" color="blur" class="white--text">Logout</v-btn>
                            </template>
                            <v-btn @click="google_login" v-if="!user" color="blur" class="white--text">Login</v-btn>
                        </v-card-actions>
                    </v-card-text>
                </v-card>



                <v-tabs v-model="tab">
                    <v-tab value="courses">Courses</v-tab>
                    <v-tab value="manage" v-if="userStatus === 1">Manage Classroom</v-tab>
                    <v-tab value="profile">Profile</v-tab>
                </v-tabs>


                <v-window v-model="tab">
                    <v-window-item value="courses">
                        <v-card>
                            <v-card-title>Courses</v-card-title>
                            <v-list>
                                <v-list-item v-for="course in courses" :key="course.id">
                                    <v-avatar size="50">
                                        <img :src="course.photo" alt="Course Image" />
                                    </v-avatar>
                                    {{ course.name }} - Room: {{ course.room }}
                                    <v-btn v-if="userStatus === 1" color="blue"
                                        @click="editClassroom(course)">Edit</v-btn>
                                    <v-btn v-if="userStatus === 1" color="red"
                                        @click="deleteClassroom(course.id)" style="margin-left: 10px;">Delete</v-btn>
                                </v-list-item>
                            </v-list>
                        </v-card>
                    </v-window-item>




                    <v-window-item value="manage" v-if="userStatus === 1">
                        <v-card>
                            <v-card-title>Manage Classroom</v-card-title>
                            <v-card-text>
                                <v-text-field v-model="newClassroom.name" label="Classroom Name"></v-text-field>
                                <v-text-field v-model="newClassroom.code" label="Classroom Code"></v-text-field>
                                <v-text-field v-model="newClassroom.room" label="Room"></v-text-field>
                                <v-text-field v-model="newClassroom.photo" label="Classroom Photo URL"></v-text-field>
                            </v-card-text>
                            <v-card-actions>
                                <v-btn color="green" @click="addClassroom">Add Classroom</v-btn>
                                <v-btn color="orange" @click="updateClassroom">Update Classroom</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-window-item>




                    <v-window-item value="profile">
                        <v-card>
                            <v-card-title>Edit Profile</v-card-title>
                            <v-card-text>
                                <v-text-field v-model="userProfile.name" label="Name"></v-text-field>
                                <v-text-field v-model="userProfile.email" label="New Email"
                                    placeholder="Enter new email"></v-text-field>
                                <v-text-field v-model="userProfile.photoURL" label="Profile Image URL"
                                    placeholder="Enter image URL"></v-text-field>
                            </v-card-text>
                            <v-card-actions>
                                <v-btn @click="updateProfile">Save</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-window-item>

                </v-window>
            </v-container>
        </v-app>
    </div>




    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQ6hymNSFTOungZGp2_iZVcNnqvVrhqJQ",
            authDomain: "web2567phupha.firebaseapp.com",
            projectId: "web2567phupha",
            storageBucket: "web2567phupha.firebasestorage.app",
            messagingSenderId: "880101399133",
            appId: "1:880101399133:web:03a059543250e03a4d4bb4",
            measurementId: "G-QDB8L9G7S4"
        };


        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const vuetify = Vuetify.createVuetify();




        const app = Vue.createApp({
            data() {
                return {
                    title: "CheckIT",
                    user: null,
                    userProfile: {},
                    userStatus: null,
                    courses: [],
                    tab: 'courses',
                    newClassroom: {
                        name: '',
                        code: '',
                        room: '',
                        photo: ''
                    }
                };
            },
            mounted() {
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        this.user = user.toJSON();
                        const doc = await db.collection("users").doc(user.uid).get();
                        if (doc.exists) {
                            this.userStatus = doc.data().classroom.status;
                        }
                    } else {
                        this.user = null;
                        this.userStatus = null;
                    }
                });
                this.loadCourses();
            },
            methods: {
                async loadCourses() {
                    this.courses = [];
                    const querySnapshot = await db.collection("classroom").get();
                    querySnapshot.forEach((doc) => {
                        this.courses.push({ id: doc.id, ...doc.data() });
                    });
                },
                google_login() {
                  firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
                },
                google_logout() {
                  firebase.auth().signOut();
                },
                async addClassroom() {
                    if (this.userStatus !== 1) return;
                    if (!this.newClassroom.name || !this.newClassroom.code || !this.newClassroom.room || !this.newClassroom.photo) {
                        alert("Please fill all required fields.");
                        return;
                    }
                    const classroomData = {
                        ...this.newClassroom,
                        owner: this.user.uid
                    };
                    await db.collection("classroom").add(classroomData);
                    alert("Classroom added successfully!");
                    this.loadCourses();
                },
                async updateClassroom() {
                    if (!this.newClassroom.id) return;
                    await db.collection("classroom").doc(this.newClassroom.id).update(this.newClassroom);
                    alert("Classroom updated successfully!");
                    this.loadCourses();
                },
                async deleteClassroom(id) {
                    if (confirm("Are you sure you want to delete this classroom?")) {
                        await db.collection("classroom").doc(id).delete();
                        alert("Classroom deleted successfully!");
                        this.loadCourses();
                    }
                },
                editClassroom(course) {
                    this.newClassroom = { ...course };
                    this.tab = 'manage';
                },
                loadUserProfile(uid) {
                    db.collection("users").doc(uid).get().then(doc => {
                        if (doc.exists) {
                            this.userProfile = doc.data();
                        }
                    });
                },
                updateProfile() {
                    if (this.user) {
                        const userRef = db.collection("users").doc(this.user.uid);


                        // Update Firestore profile with the new name and photo URL
                        userRef.set(this.userProfile, { merge: true }).then(() => {
                            // Update Firebase Authentication profile
                            if (this.userProfile.email !== this.user.email) {
                                // Changing email address in Firebase Authentication
                                firebase.auth().currentUser.updateEmail(this.userProfile.email).then(() => {
                                    alert("Email updated! Please check your inbox to verify your new email.");


                                    // Send a verification email
                                    firebase.auth().currentUser.sendEmailVerification().then(() => {
                                        alert("Verification email sent. Please verify your new email address.");
                                    }).catch(error => {
                                        console.error("Error sending verification email: ", error);
                                    });


                                    // Update the user.email in Vue instance to reflect the change
                                    this.user.email = this.userProfile.email;  // Update email in Vue data
                                }).catch(error => {
                                    console.error("Error updating email: ", error);
                                    alert("Error updating email. Please try again.");
                                });
                            }


                            // Update displayName and photoURL in Firebase Authentication
                            firebase.auth().currentUser.updateProfile({
                                displayName: this.userProfile.name,
                                photoURL: this.userProfile.photoURL
                            }).then(() => {
                                alert("Profile updated successfully!");
                                this.user.displayName = this.userProfile.name;
                                this.user.photoURL = this.userProfile.photoURL;
                            }).catch(error => {
                                console.error("Error updating Firebase Authentication profile: ", error);
                            });
                        }).catch(error => {
                            console.error("Error updating Firestore user profile: ", error);
                        });
                    }
                } ,

            }
        });


        app.use(vuetify).mount("#app");
    </script>
</body>


</html>




