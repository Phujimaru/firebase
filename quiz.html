<!DOCTYPE html>
<html>

<head>
    <title>Create Quiz</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.js"></script>
</head>

<body>


    <div id="app">
        <v-app>
            <v-container>
                <v-card class="pa-5" elevation="10">
                    <v-card-title class="header-title">
                        <i class="fa-solid fa-user-check"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                    </v-card-title>

                    <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°) -->
                    <div v-if="status === 1">
                        <v-text-field v-model="question" label="‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠" outlined dense></v-text-field>
                        <v-text-field v-model="answer" label="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" outlined dense></v-text-field>
                        <v-text-field v-model="timeLimit" label="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)" outlined dense
                            type="number"></v-text-field>
                        <v-btn @click="submitAttendanceQuestion" color="green" block>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</v-btn>
                    </div>

                    <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°) -->
                    <div v-else-if="status === 2">
                        <div v-if="quiz">
                            <p><strong>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</strong> {{ quiz.question }}</p>
                            <v-text-field v-model="userAnswer" label="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö" outlined dense></v-text-field>
                            <v-btn @click="submitAnswer" color="blue" block>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</v-btn>
                            <p>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {{ timeLeft }} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
                        </div>
                        <div v-else>
                            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</p>
                        </div>
                    </div>
                </v-card>
            </v-container>
        </v-app>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCsB5O8vwk_EhCmME6Zg6CqN1gVFl4eJik",
            authDomain: "projectwebm2025.firebaseapp.com",
            projectId: "projectwebm2025",
            storageBucket: "projectwebm2025.firebasestorage.app",
            messagingSenderId: "316415805582",
            appId: "1:316415805582:web:582b27fa7d4f8974bee1df",
            measurementId: "G-EC8J8RGC0T"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const { createApp, ref } = Vue;
        const vuetify = Vuetify.createVuetify();

        createApp({
            data() {
                return {
                    classroomId: new URLSearchParams(window.location.search).get('classroomId'),
                    question: '',
                    answer: '',
                    timeLimit: 0,
                    status: 0,
                    user: null,
                    quiz: null,
                    userAnswer: '',
                    timeLeft: 0,
                    interval: null,
                };
            },
            methods: {
                async checkUserLogin() {
                    firebase.auth().onAuthStateChanged(user => {
                        if (user) {
                            this.user = user;
                            this.getUserStatus();
                        } else {
                            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô!");
                            window.location.href = "index.html";
                        }
                    });
                },
                async getUserStatus() {
                    const userRef = db.collection("users").doc(this.user.uid);
                    const doc = await userRef.get();
                    if (doc.exists) {
                        this.status = doc.data().status;
                        if (this.status === 2) {
                            this.fetchQuiz();
                        }
                    }
                },

                async submitAttendanceQuestion() {
                    if (!this.question || !this.answer || !this.timeLimit) {
                        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!");
                        return;
                    }

                    const quizRef = db.collection("classrooms")
                        .doc(this.classroomId)
                        .collection("attendanceQuestions")
                        .doc();

                    const quizData = {
                        questionId: quizRef.id,
                        question: this.question,
                        correctAnswer: this.answer.trim().toLowerCase(),
                        timeLimit: this.timeLimit * 60,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        await quizRef.set(quizData);

                        alert("‚úÖ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                        window.location.href = "manage.html?classroomId=" + this.classroomId; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ manage.html
                    } catch (error) {
                        console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
                    }
                },

                async fetchQuiz() {
                    try {
                        // üîπ ‡∏î‡∏∂‡∏á `quiz` ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
                        const snapshot = await db.collection("classrooms")
                            .doc(this.classroomId)
                            .collection("attendanceQuestions")
                            .orderBy("createdAt", "desc")
                            .limit(1)
                            .get();

                        if (snapshot.empty) {
                            console.log("üìå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà");
                            return;
                        }

                        const quizData = snapshot.docs[0].data();
                        this.quiz = quizData;

                        // üîπ ‡∏î‡∏∂‡∏á `userId` ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô classroom
                        const studentSnapshot = await db.collection("classrooms")
                            .doc(this.classroomId)
                            .collection("students")  // üîπ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å students ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á
                            .get();

                        const studentIds = studentSnapshot.docs.map(doc => doc.id);

                        // üîπ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ `userId` ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô classroom ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        if (!studentIds.includes(this.user.uid)) {
                            console.warn("üö´ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô!");
                            this.quiz = null;
                            return;
                        }

                        console.log("‚úÖ ‡πÇ‡∏´‡∏•‡∏î quiz ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", this.quiz);
                        this.startTimer();

                    } catch (error) {
                        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î quiz ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                    }
                }

                ,




                async startTimer() {
                    const now = firebase.firestore.Timestamp.now().seconds;
                    const endTime = this.quiz.createdAt.seconds + this.quiz.timeLimit;
                    this.timeLeft = Math.max(0, endTime - now);

                    this.interval = setInterval(async () => {
                        if (this.timeLeft > 0) {
                            this.timeLeft--;
                        } else {
                            clearInterval(this.interval);
                            alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠!");

                            const responseRef = db.collection("classrooms").doc(this.classroomId)
                                .collection("attendanceQuestions").doc(this.quiz.questionId)
                                .collection("attendanceResponses");

                            // üîπ ‡∏î‡∏∂‡∏á `userId` ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                            const responseSnapshot = await responseRef.get();
                            const answeredUserIds = new Set(responseSnapshot.docs.map(doc => doc.data().userId));

                            // üîπ ‡∏î‡∏∂‡∏á `userId` ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô `classroom/students`
                            const studentsSnapshot = await db.collection("classrooms")
                                .doc(this.classroomId)
                                .collection("students")
                                .get();

                            studentsSnapshot.forEach(async (userDoc) => {
                                const studentId = userDoc.id;

                                // üîπ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ `userId` ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô `attendanceResponses` ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                                if (!answeredUserIds.has(studentId)) {
                                    // üîπ ‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô
                                    const existingCheck = await responseRef
                                        .where("userId", "==", studentId)
                                        .get();

                                    if (existingCheck.empty) {
                                        // üîπ ‡∏ñ‡πâ‡∏≤ `userId` ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        await responseRef.add({
                                            userId: studentId,
                                            answer: null,  // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                                            isCorrect: false, // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö = ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                                            status: 0,  // ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                        });


                                        // üîπ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                                        await db.collection("classrooms")
                                            .doc(this.classroomId)
                                            .collection("students")
                                            .doc(studentId)
                                            .set({ scores: 0 }, { merge: true });

                                        // üîπ ‡πÄ‡∏û‡∏¥‡πà‡∏° `userId` ‡∏•‡∏á‡πÉ‡∏ô `answeredUserIds` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥
                                        answeredUserIds.add(studentId);
                                    }




                                }
                            });
                        }
                    }, 1000);
                },


                async submitAnswer() {
                    if (!this.userAnswer) {
                        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á!");
                        return;
                    }

                    if (!this.quiz || !this.quiz.questionId) {
                        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà!");
                        return;
                    }

                    const responseRef = db.collection("classrooms").doc(this.classroomId)
                        .collection("attendanceQuestions").doc(this.quiz.questionId)
                        .collection("attendanceResponses");

                    const studentRef = db.collection("classrooms")
                        .doc(this.classroomId)
                        .collection("students")
                        .doc(this.user.uid);

                    try {
                        // üîπ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        const existingResponse = await responseRef
                            .where("userId", "==", this.user.uid)
                            .get();

                        if (!existingResponse.empty) {
                            alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!");
                            return;
                        }

                        // üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å `students`
                        const studentDoc = await studentRef.get();
                        let currentScore = 0;

                        if (studentDoc.exists) {
                            currentScore = studentDoc.data().scores || 0; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 0
                        }

                        // üîπ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                        const isCorrect = this.userAnswer.trim().toLowerCase() === this.quiz.correctAnswer;

                        // üîπ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏á `attendanceResponses`
                        await responseRef.add({
                            userId: this.user.uid,
                            answer: this.userAnswer,
                            isCorrect: isCorrect,
                            status: 1, // ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ = ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            scores: 1, // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏¥‡∏ã‡∏ô‡∏µ‡πâ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô attendanceResponses)
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // üîπ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô `students`
                        await studentRef.update({
                            scores: currentScore + 1 // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô students ‡∏ó‡∏µ‡∏•‡∏∞ 1
                        });

                        alert(`‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${currentScore + 1}`);
                        window.location.href = "index.html";

                    } catch (error) {
                        console.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                    }
                }




            },

            created() {
                this.checkUserLogin();
            }
        }).use(vuetify).mount("#app");



    </script>


</body>

</html>
