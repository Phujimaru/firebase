<!DOCTYPE html>
<html>

<head>
    <title>Create Quiz</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.10/dist/vuetify.min.js"></script>
</head>

<body>

    <div id="app">
        <v-app>
            <v-container>
                <v-card class="pa-5" elevation="10">
                    <v-card-title class="header-title">
                        <i class="fa-solid fa-user-check"></i> เช็คชื่อ
                    </v-card-title>

                    <!-- สำหรับอาจารย์ (สร้างคำถาม) -->
                    <div v-if="status === 1">
                        <v-text-field v-model="question" label="คำถามเช็คชื่อ" outlined dense></v-text-field>
                        <v-text-field v-model="answer" label="คำตอบที่ถูกต้อง" outlined dense></v-text-field>
                        <v-text-field v-model="timeLimit" label="กำหนดเวลา (นาที)" outlined dense
                            type="number"></v-text-field>
                        <v-btn @click="submitAttendanceQuestion" color="green" block>สร้างคำถาม</v-btn>
                    </div>

                    <!-- สำหรับนักเรียน (ตอบคำถาม) -->
                    <div v-else-if="status === 2">
                        <div v-if="quiz">
                            <p><strong>คำถาม:</strong> {{ quiz.question }}</p>
                            <v-text-field v-model="userAnswer" label="พิมพ์คำตอบ" outlined dense></v-text-field>
                            <v-btn @click="submitAnswer" color="blue" block>ส่งคำตอบ</v-btn>
                            <p>เวลาที่เหลือ: {{ timeLeft }} วินาที</p>
                        </div>
                        <div v-else>
                            <p>ไม่มีคำถามเช็คชื่อที่เปิดอยู่</p>
                        </div>
                    </div>
                </v-card>
            </v-container>
        </v-app>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCsB5O8vwk_EhCmME6Zg6CqN1gVFl4eJik",
            authDomain: "projectwebm2025.firebaseapp.com",
            projectId: "projectwebm2025",
            storageBucket: "projectwebm2025.firebasestorage.app",
            messagingSenderId: "316415805582",
            appId: "1:316415805582:web:582b27fa7d4f8974bee1df",
            measurementId: "G-EC8J8RGC0T"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const { createApp, ref } = Vue;
        const vuetify = Vuetify.createVuetify();

        createApp({
            data() {
                return {
                    classroomId: new URLSearchParams(window.location.search).get('classroomId'),
                    question: '',
                    answer: '',
                    timeLimit: 0,
                    status: 0,
                    user: null,
                    quiz: null,
                    userAnswer: '',
                    timeLeft: 0,
                    interval: null,
                };
            },
            methods: {
                async checkUserLogin() {
                    firebase.auth().onAuthStateChanged(user => {
                        if (user) {
                            this.user = user;
                            this.getUserStatus();
                        } else {
                            alert("กรุณาเข้าสู่ระบบก่อน!");
                            window.location.href = "index.html";
                        }
                    });
                },
                async getUserStatus() {
                    const userRef = db.collection("users").doc(this.user.uid);
                    const doc = await userRef.get();
                    if (doc.exists) {
                        this.status = doc.data().status;
                        if (this.status === 2) {
                            this.fetchQuiz();
                        }
                    }
                },
                async submitAttendanceQuestion() {
                    if (!this.question || !this.answer || !this.timeLimit) {
                        alert("กรุณากรอกข้อมูลให้ครบถ้วน!");
                        return;
                    }

                    const quizData = {
                        question: this.question,
                        correctAnswer: this.answer.trim().toLowerCase(),
                        timeLimit: this.timeLimit * 60, // แปลงเป็นวินาที
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        await db.collection("classrooms")
                            .doc(this.classroomId)
                            .collection("attendanceQuestions")
                            .add(quizData);

                        alert("✅ คำถามเช็คชื่อถูกสร้างเรียบร้อย!");
                        window.location.href = "manage.html?classroomId=" + this.classroomId; // ⬅️ กลับไป manage.html
                    } catch (error) {
                        console.error("❌ เกิดข้อผิดพลาด:", error);
                    }
                },
                async fetchQuiz() {
                    const snapshot = await db.collection("classrooms")
                        .doc(this.classroomId)
                        .collection("attendanceQuestions")
                        .orderBy("createdAt", "desc")
                        .limit(1)
                        .get();

                    if (!snapshot.empty) {
                        this.quiz = snapshot.docs[0].data();
                        this.startTimer();
                    }
                },
                startTimer() {
                    const now = firebase.firestore.Timestamp.now().seconds;
                    const endTime = this.quiz.createdAt.seconds + this.quiz.timeLimit;
                    this.timeLeft = Math.max(0, endTime - now);

                    this.interval = setInterval(() => {
                        if (this.timeLeft > 0) {
                            this.timeLeft--;
                        } else {
                            clearInterval(this.interval);
                            alert("หมดเวลาในการเช็คชื่อ!");
                        }
                    }, 1000);
                },
                async submitAnswer() {
                    if (!this.userAnswer) {
                        alert("กรุณาใส่คำตอบ");
                        return;
                    }

                    const isCorrect = this.userAnswer.trim().toLowerCase() === this.quiz.correctAnswer;

                    try {
                        await db.collection("classrooms")
                            .doc(this.classroomId)
                            .collection("attendanceResponses")
                            .add({
                                userId: this.user.uid,
                                answer: this.userAnswer,
                                isCorrect: isCorrect,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });

                        if (isCorrect) {
                            alert("✅ เช็คชื่อสำเร็จ!");
                        } else {
                            alert("❌ คำตอบไม่ถูกต้อง!");
                        }

                        clearInterval(this.interval);

                        // เช็คว่าสถานะเป็นนักเรียน (status === 2) → กลับไป index.html
                        if (this.status === 2) {
                            window.location.href = "index.html";
                        } else {
                            window.location.href = "manage.html?classroomId=" + this.classroomId;
                        }
                    } catch (error) {
                        console.error("❌ เกิดข้อผิดพลาดในการส่งคำตอบ:", error);
                    }
                }


            },
            created() {
                this.checkUserLogin();
            }
        }).use(vuetify).mount("#app");
    </script>

</body>

</html>
