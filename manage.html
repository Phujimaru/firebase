<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Classroom</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!--QR code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7fb;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* ‡πÉ‡∏ä‡πâ min-height ‡πÅ‡∏ó‡∏ô height ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô */
            margin: 0;
            overflow-y: auto;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ */
        }

        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 20px;
        }

        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            padding: 20px;
            height: 100%;
            border-radius: 10px;
            margin-right: 20px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        .content {
            flex: 1;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: inset 0px 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .right-sidebar {
            width: 250px;
            background-color: #f8f9fa;
            padding: 20px;
            height: 100%;
            border-radius: 10px;
            margin-left: 20px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }



        .classroom-info img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        #qrcode {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #007bff;
            color: white;
            border-radius: 5px;
        }

        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.3s ease;
            margin: 10px 0;
        }

        button:hover {
            background-color: #218838;
        }

        .back-button {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #ffffff;
            color: #007bff;
            border: 2px solid #007bff;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 10px;
            text-decoration: none;
        }

        .back-button:hover {
            background-color: #007bff;
            color: white;
        }

        .user-list li {
            background-color: #fff;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            margin-left: -28px;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
        }

        .user-list img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }



        .users-container {
            display: flex;
            overflow-y: auto;
            flex-direction: row;
            /* ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏£‡∏∞‡∏ô‡∏≤‡∏ö */
            gap: 20px;
        }

        .quiz-container {
            background-color: #fff;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
    </style>



</head>

<body>
    <div class="header">
        Manage Classroom
        <button onclick="window.location.href='index.html'"
            style="float: right; background-color: red; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="classroom-info" id="classroom-info">
                <p>Loading classroom details...</p>
            </div>
            <div id="qrcode"></div> <br>
            <p id="classroom-id-display" style="text-align: center; font-weight: bold; color: white;"></p>
        </div>

        <div class="main-content">
            <!-- Quiz Section -->
            <div class="quiz-container">
                <h2>Quiz</h2>
                <button onclick="goToQuizPage()"
                    style="background-color: green; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                    Create Quiz
                </button>



                <!-- üîπ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö -->
                <table id="quizTable" border="1" style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î</th>
                            <th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</th>
                            <th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody id="quizTableBody">
                        <!-- üîπ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </tbody>
                </table>


            </div>

            <!-- Users Management Section -->
            <div class="users-container">
                <div class="content">
                    <h2 onclick="toggleManageUsers()" style="cursor: pointer; display: flex; align-items: center;">
                        Manage Users
                        <span id="toggleIcon" style="margin-left: 10px;">üîΩ</span>
                    </h2>

                    <div id="manageUsersContent">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Photo</th>
                                    <th>Add to Classroom</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                </div>



                <div class="right-sidebar">
                    <h3>
                        Users in Classroom
                    </h3>

                    <ul v-if="isClassUsersDropdownOpen" id="classUsersList" class="user-list"></ul>
                </div>

            </div>

        </div>


        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyCsB5O8vwk_EhCmME6Zg6CqN1gVFl4eJik",
                authDomain: "projectwebm2025.firebaseapp.com",
                projectId: "projectwebm2025",
                storageBucket: "projectwebm2025.appspot.com",
                messagingSenderId: "316415805582",
                appId: "1:316415805582:web:582b27fa7d4f8974bee1df",
                measurementId: "G-EC8J8RGC0T"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            const params = new URLSearchParams(window.location.search);
            const classroomId = params.get("classroomId");

            if (!classroomId) {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö classroomId ‡πÉ‡∏ô URL");
                window.location.href = "index.html";
            }

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    db.collection("classrooms").doc(classroomId).get().then(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            document.getElementById("classroom-info").innerHTML = `
                                    <h2>${data.name}</h2>
                                    <p>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå: ${data.teacher}</p>
                                    <p>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤: ${data.subjectCode}</p>
                                    <img src="${data.image}" alt="Classroom Image">
                                `;
                            generateQRCode();
                            loadUsers();
                            loadClassroomUsers();
                        } else {
                            document.getElementById("classroom-info").innerHTML = "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>";
                        }
                    });
                } else {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô!");
                    window.location.href = "index.html";
                }
            });


            function goToQuizPage() {
                window.location.href = `quiz.html?classroomId=${classroomId}`;
            }


            function generateQRCode() {
                const classroomIdText = `Classroom ID: ${classroomId}`; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏•‡∏≤‡∏™‡∏£‡∏π‡∏°

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏•‡∏≤‡∏™‡∏£‡∏π‡∏°
                new QRCode(document.getElementById("qrcode"), {
                    text: classroomIdText,
                    width: 200,
                    height: 200
                });

                // ‡πÅ‡∏™‡∏î‡∏á Classroom ID ‡πÉ‡∏ï‡πâ QR Code
                document.getElementById("classroom-id-display").innerText = classroomIdText;
            }







            function loadUsers() {
                const usersTable = document.getElementById("usersTable");
                usersTable.innerHTML = "";

                db.collection("users").get().then(snapshot => {
                    snapshot.forEach(userDoc => {
                        const userData = userDoc.data();
                        if (userData.status !== 2) return; // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ status = 2

                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô classroom ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                        db.collection("classrooms").doc(classroomId).collection("students").doc(userDoc.id).get().then(classUserDoc => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                    <td>${userData.name}</td>
                                    <td>${userData.email}</td>
                                    <td><img src="${userData.photo}" width="50"></td>
                                    <td>${classUserDoc.exists ? "‚úÖ Already in class" : `<button onclick="addUserToClass('${userDoc.id}')">Add</button>`}</td>
                                `;
                            usersTable.appendChild(row);
                        });
                    });
                });
            }

            function addUserToClass(userId) {
                db.collection("users").doc(userId).get().then(userDoc => {
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const studentData = {
                            userId: userId,
                            name: userData.name || "No Name",
                            email: userData.email || "No Email",
                            photo: userData.photo || "default-profile.png",
                            status: 2
                        };

                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô classrooms/{classroomId}/students/{userId}
                        db.collection("classrooms").doc(classroomId)
                            .collection("students").doc(userId)
                            .set(studentData)
                            .then(() => {
                                console.log("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

                                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° classroom ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô users/{userId}/classrooms/{classroomId}
                                db.collection("users").doc(userId)
                                    .collection("classrooms").doc(classroomId)
                                    .set({
                                        classroomId: classroomId,
                                        name: userData.name || "No Name",
                                        teacher: userData.teacher || "Unknown Teacher",
                                        subjectCode: userData.subjectCode || "No Code",
                                        image: userData.image || "",
                                        joinedAt: firebase.firestore.FieldValue.serverTimestamp() // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                                    })
                                    .then(() => {
                                        console.log("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏•‡∏á‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                                        loadClassroomUsers();
                                        loadUsers(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î user list ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° Add
                                    })
                                    .catch(error => {
                                        console.error("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏≤‡∏™‡πÉ‡∏ô users ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
                                    });

                            })
                            .catch(error => {
                                console.error("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô classrooms ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
                            });
                    } else {
                        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ!");
                    }
                }).catch(error => {
                    console.error("‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                });
            }


            function loadClassroomUsers() {
                const userList = document.getElementById("classUsersList");
                userList.innerHTML = "";

                db.collection("classrooms").doc(classroomId)
                    .collection("students").where("status", "==", 2)
                    .get()
                    .then(snapshot => {
                        userList.innerHTML = "";
                        snapshot.forEach(doc => {
                            let data = doc.data();
                            let name = data.name || "No Name";
                            let photo = data.photo || "default-profile.png";

                            userList.innerHTML += `
                                    <li style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <img src="${photo}" alt="Profile" 
                                             style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                                        <span>${name}</span>
                                        <button onclick="removeUserFromClass('${doc.id}')" style="margin-left: 10px; background-color: red; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‡∏•‡∏ö</button>
                                    </li>
                                `;
                        });
                    })
                    .catch(error => {
                        console.error("‚ùå Error fetching students:", error);
                    });
            }
            function removeUserFromClass(userId) {
                // ‡∏Ç‡∏±‡πâ‡∏ô‡πÅ‡∏£‡∏Å ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å collection students ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                db.collection("classrooms").doc(classroomId)
                    .collection("students").doc(userId)
                    .delete()
                    .then(() => {
                        console.log("‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

                        // ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                        db.collection("users").doc(userId)
                            .collection("classrooms").doc(classroomId)
                            .delete()
                            .then(() => {
                                console.log("‚úÖ ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

                                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                loadClassroomUsers();
                                loadUsers();  // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° "Add"
                            })
                            .catch(error => {
                                console.error("‚ùå ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                            });

                    })
                    .catch(error => {
                        console.error("‚ùå ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                    });
            }


            document.addEventListener("DOMContentLoaded", function () {
                const content = document.getElementById("manageUsersContent");
                const icon = document.getElementById("toggleIcon");

                content.style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô dropdown ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                icon.innerText = "‚ñ∂Ô∏è"; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏ß‡∏≤ (‡∏õ‡∏¥‡∏î)
            });

            function toggleManageUsers() {
                const content = document.getElementById("manageUsersContent");
                const icon = document.getElementById("toggleIcon");

                if (content.style.display === "none" || content.style.display === "") {
                    content.style.display = "block";  // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                    icon.innerText = "üîΩ"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏•‡∏á
                } else {
                    content.style.display = "none";  // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                    icon.innerText = "‚ñ∂Ô∏è"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏ß‡∏≤
                }
            }


            function formatDateTime(date) {
                return date.toLocaleString("th-TH", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hourCycle: "h23",
                    timeZone: "Asia/Bangkok"
                }).replace(",", ""); // ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ "," ‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
            }

            function loadAttendanceQuestions() {
                const tableBody = document.getElementById("quizTableBody");
                tableBody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";

                db.collection("classrooms").doc(classroomId).collection("attendanceQuestions").get()
                    .then(snapshot => {
                        tableBody.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

                        if (snapshot.empty) {
                            tableBody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</td></tr>";
                            return;
                        }

                        snapshot.forEach(doc => {
                            const questionData = doc.data();
                            const questionId = doc.id;
                            const createdAt = questionData.createdAt?.toDate() || null;
                            const timeLimit = questionData.timeLimit || 0;

                            let createdAtText = createdAt ? formatDateTime(createdAt) : "N/A";
                            let endTimeText = createdAt ? formatDateTime(new Date(createdAt.getTime() + timeLimit * 1000)) : "N/A";

                            const row = document.createElement("tr");
                            row.innerHTML = `
                    <td>${questionData.question}</td>
                    <td>
                        <strong>‡πÄ‡∏£‡∏¥‡πà‡∏°:</strong> ${createdAtText} <br>
                        <strong>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong> ${endTimeText}
                    </td>
                    <td>${questionData.correctAnswer}</td>
                    <td>
                        <details>
                            <summary style="cursor: pointer; color: blue;">‡∏î‡∏π‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</summary>
                            <div id="responses-${questionId}" style="padding: 10px;">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                        </details>
                    </td>
                `;

                            tableBody.appendChild(row);
                            loadAttendanceResponses(questionId); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ
                        });
                    })
                    .catch(error => {
                        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                    });
            }



            function loadAttendanceResponses(questionId) {
                const responseCell = document.getElementById(`responses-${questionId}`);
                responseCell.innerHTML = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

                db.collection("classrooms").doc(classroomId)
                    .collection("attendanceQuestions").doc(questionId)
                    .collection("attendanceResponses")
                    .orderBy("timestamp", "desc")
                    .get()
                    .then(snapshot => {
                        if (snapshot.empty) {
                            responseCell.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
                            return;
                        }

                        let responseHTML = "<ul style='padding-left: 10px;'>";
                        let promises = [];

                        snapshot.forEach(doc => {
                            const responseData = doc.data();
                            const userId = responseData.userId;
                            const status = responseData.status; // ‡πÉ‡∏ä‡πâ status ‡∏Ç‡∏≠‡∏á attendanceResponses
                            const timestamp = responseData.timestamp?.toDate().toLocaleString("th-TH") || "N/A";

                            // ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                            const statusText = status === 1 ? "‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";

                            // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                            const userPromise = db.collection("users").doc(userId).get().then(userDoc => {
                                const userData = userDoc.exists ? userDoc.data() : { name: "Unknown User" };
                                responseHTML += `<li><strong>${userData.name}</strong> - ${timestamp} - <span style="color: ${status === 1 ? 'green' : 'red'};">${statusText}</span></li>`;
                            });

                            promises.push(userPromise);
                        });

                        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HTML
                        Promise.all(promises).then(() => {
                            responseHTML += "</ul>";
                            responseCell.innerHTML = responseHTML;
                        });
                    })
                    .catch(error => {
                        responseCell.innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
                        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                    });


                if (endTime) {
                    markAbsentStudents(questionId, endTime);
                }
            }

            // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            document.addEventListener("DOMContentLoaded", function () {
                loadAttendanceQuestions();
            });






            function checkAndMarkAbsentStudents() {
                db.collection("classrooms").doc(classroomId).collection("attendanceQuestions").get()
                    .then(snapshot => {
                        snapshot.forEach(questionDoc => {
                            const questionData = questionDoc.data();
                            const questionId = questionDoc.id;
                            const createdAt = questionData.createdAt?.toDate();
                            const timeLimit = questionData.timeLimit || 0;
                            const endTime = createdAt ? new Date(createdAt.getTime() + timeLimit * 1000) : null;

                            if (endTime && new Date() > endTime) {
                                // ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß -> ‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö
                                db.collection("classrooms").doc(classroomId).collection("students").get()
                                    .then(studentSnapshot => {
                                        studentSnapshot.forEach(studentDoc => {
                                            const studentId = studentDoc.id;

                                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                                            db.collection("classrooms").doc(classroomId)
                                                .collection("attendanceQuestions").doc(questionId)
                                                .collection("attendanceResponses").doc(studentId)
                                                .get()
                                                .then(responseDoc => {
                                                    if (!responseDoc.exists) {
                                                        // ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö -> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (0)
                                                        db.collection("classrooms").doc(classroomId)
                                                            .collection("attendanceQuestions").doc(questionId)
                                                            .collection("attendanceResponses").doc(studentId)
                                                            .set({
                                                                userId: studentId,
                                                                status: 0, // ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                                            })
                                                            .then(() => {
                                                                console.log(`‚úÖ Marked ${studentId} as absent for question ${questionId}`);
                                                            })
                                                            .catch(error => {
                                                                console.error("‚ùå Error marking absent:", error);
                                                            });
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error("‚ùå Error checking response:", error);
                                                });
                                        });
                                    })
                                    .catch(error => {
                                        console.error("‚ùå Error fetching students:", error);
                                    });
                            }
                        });
                    })
                    .catch(error => {
                        console.error("‚ùå Error fetching attendance questions:", error);
                    });
            }

            // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
            setInterval(checkAndMarkAbsentStudents, 60000);


            function markAbsentStudents(questionId, endTime) {
                const currentTime = new Date();
                if (currentTime < endTime) {
                    console.log("‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ");
                    return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
                }

                // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å classroom
                db.collection("classrooms").doc(classroomId)
                    .collection("students").get()
                    .then(studentSnapshot => {
                        const allStudents = studentSnapshot.docs.map(doc => doc.id); // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ userId ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

                        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ userId ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô attendanceResponses
                        db.collection("classrooms").doc(classroomId)
                            .collection("attendanceQuestions").doc(questionId)
                            .collection("attendanceResponses").get()
                            .then(responseSnapshot => {
                                const respondedStudents = responseSnapshot.docs.map(doc => doc.id); // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ userId ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß

                                // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô attendanceResponses
                                const absentStudents = allStudents.filter(userId => !respondedStudents.includes(userId));

                                if (absentStudents.length === 0) {
                                    console.log("‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°");
                                    return;
                                }

                                console.log("‚ùå ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô attendanceResponses:", absentStudents);

                                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÉ‡∏ô attendanceResponses
                                const batch = db.batch();
                                absentStudents.forEach(userId => {
                                    const absentRef = db.collection("classrooms").doc(classroomId)
                                        .collection("attendanceQuestions").doc(questionId)
                                        .collection("attendanceResponses").doc(userId);

                                    batch.set(absentRef, {
                                        userId: userId,
                                        status: 0, // ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                });

                                batch.commit()
                                    .then(() => {
                                        console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${absentStudents.length} ‡∏Ñ‡∏ô`);
                                    })
                                    .catch(error => {
                                        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ:", error);
                                    });

                            })
                            .catch(error => {
                                console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î attendanceResponses ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                            });
                    })
                    .catch(error => {
                        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                    });
            }



        </script>
</body>

</html>
